<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBL Grocery Scanner - Transparent Certification Scoring</title>
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <style>
        /* ==================== */
        /* RESET & BASE STYLES  */
        /* ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        /* ==================== */
        /* TYPOGRAPHY & GLOBAL  */
        /* ==================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ==================== */
        /* LAYOUT COMPONENTS    */
        /* ==================== */
        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .content {
            padding: 25px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        /* ==================== */
        /* HEADER & NAVIGATION  */
        /* ==================== */
        .header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.1;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
            color: #c8e6c9;
        }

        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            backdrop-filter: blur(10px);
            z-index: 100;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-info a {
            color: white;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 5px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 8px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
            min-width: 80px;
            white-space: nowrap;
            user-select: none;
        }

        .nav-tab.active {
            color: #2e7d32;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #2e7d32;
            border-radius: 3px 3px 0 0;
        }

        .nav-tab:focus {
            outline: 2px solid #2e7d32;
            outline-offset: 2px;
        }

        /* ==================== */
        /* FORM ELEMENTS        */
        /* ==================== */
        input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus {
            outline: none;
            border-color: #2e7d32;
            background: white;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            user-select: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 125, 50, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:focus {
            outline: 2px solid #2e7d32;
            outline-offset: 2px;
        }

        /* Button Variants */
        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        button.secondary:hover {
            box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
        }

        button.excel {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        }

        button.excel:hover {
            box-shadow: 0 10px 20px rgba(13, 110, 253, 0.3);
        }

        button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.danger:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        button.info {
            background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);
        }

        button.info:hover {
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }

        button.test-button {
            background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);
            margin-top: 10px;
        }

        /* ==================== */
        /* SCANNER COMPONENTS   */
        /* ==================== */
        #interactive.viewport {
            width: 100%;
            height: 280px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            background: #1a1a1a;
            margin-bottom: 20px;
            border: 3px solid #2e7d32;
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .scanner-line {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 3px;
            background: #2e7d32;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 10px #2e7d32;
        }

        /* Scanner detection indicator */
        .detection-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 20;
            display: none;
        }

        .detection-active {
            background: rgba(46, 125, 50, 0.8);
        }

        /* ==================== */
        /* RESULTS DISPLAY      */
        /* ==================== */
        .result-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            display: none;
            animation: slideUp 0.5s ease;
        }

        .result-card.showing {
            animation: slideInUp 0.5s ease-out;
        }

        .product-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .product-info h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto 30px auto;
            border: 8px solid #a5d6a7;
            box-shadow: 0 10px 30px rgba(46, 125, 50, 0.3);
            position: relative;
        }

        .score-circle .val {
            font-size: 42px;
            font-weight: bold;
            line-height: 1;
        }

        .score-circle .label {
            font-size: 12px;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .score-grade {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff6b6b;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        .pillar {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 16px;
        }

        .pillar:last-child {
            border-bottom: none;
        }

        .pillar span:first-child {
            color: #495057;
        }

        .pillar span:last-child {
            font-weight: bold;
            color: #2e7d32;
            font-size: 18px;
        }

        /* ==================== */
        /* CERTIFICATION BADGES */
        /* ==================== */
        .cert-tag {
            display: inline-block;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            margin: 6px;
            border: 2px solid #2e7d32;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.1);
        }

        .cert-source {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .cert-status {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .excel-found {
            color: #198754;
            font-weight: bold;
        }

        .excel-not-found {
            color: #dc3545;
            font-weight: bold;
        }

        .no-certs {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 15px;
        }

        /* ==================== */
        /* INFORMATION BOXES    */
        /* ==================== */
        .excel-details {
            background: #e7f5ff;
            border: 1px solid #a5d8ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }

        .excel-details h4 {
            color: #0d6efd;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .search-guide {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2e7d32;
        }

        .search-guide h4 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .search-guide p {
            margin: 5px 0;
            font-size: 14px;
            color: #495057;
        }

        .search-guide .tip {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
        }

        .methodology-info {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .methodology-info h4 {
            color: #e65100;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .methodology-info p {
            margin: 5px 0;
            font-size: 13px;
            color: #5a3e1b;
        }

        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }

        /* ==================== */
        /* HISTORY & DATA       */
        /* ==================== */
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-left: 4px solid #2e7d32;
        }

        /* ==================== */
        /* STATUS & BADGES      */
        /* ==================== */
        .extraction-confidence {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }

        .brand-extraction-badge {
            display: inline-block;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
            border: 1px solid #90caf9;
        }

        .consistency-badge {
            display: inline-block;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
            border: 1px solid #2e7d32;
        }

        /* ==================== */
        /* FEEDBACK & MESSAGES  */
        /* ==================== */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #2e7d32;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2e7d32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        .error-msg {
            color: #dc3545;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
            border: 2px solid #dc3545;
            font-weight: 500;
        }

        .success-msg {
            color: #2e7d32;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
            border: 2px solid #2e7d32;
            font-weight: 500;
        }

        .debug-info {
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        /* ==================== */
        /* UTILITY & MISC       */
        /* ==================== */
        .transparency-link {
            text-align: center;
            margin: 15px 0;
        }

        .transparency-link a {
            color: #2e7d32;
            text-decoration: none;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .transparency-link a:hover {
            text-decoration: underline;
        }

        hr {
            margin: 25px 0;
            border: none;
            height: 1px;
            background: linear-gradient(to right, transparent, #dee2e6, transparent);
        }

        /* ==================== */
        /* ANIMATIONS           */
        /* ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scan {
            0%, 100% { top: 20%; }
            50% { top: 80%; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes scanSuccess {
            0% { background-color: #1a1a1a; }
            50% { background-color: #4caf50; }
            100% { background-color: #1a1a1a; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes detectionPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Animation Classes */
        .scan-success {
            animation: scanSuccess 0.5s ease-in-out;
        }

        .scan-again {
            animation: pulse 2s infinite;
            background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%) !important;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .detection-pulse {
            animation: detectionPulse 0.5s ease-in-out;
        }

        /* ==================== */
        /* RESPONSIVE DESIGN    */
        /* ==================== */
        /* Better tap targets for mobile */
        @media (max-width: 480px) {
            button, .nav-tab {
                min-height: 44px; /* Apple's recommended minimum tap target */
            }

            input {
                font-size: 16px; /* Prevents iOS zoom on focus */
                min-height: 44px;
            }

            .container {
                margin: 10px;
                border-radius: 20px;
            }
        }

        /* ==================== */
        /* ACCESSIBILITY FEATURES */
        /* ==================== */
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d3748 100%);
            }

            .container {
                background: #2d2d2d;
                color: #e2e8f0;
            }

            input {
                background: #3a3a3a;
                border-color: #4a5568;
                color: #e2e8f0;
            }

            input:focus {
                background: #2d2d2d;
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ==================== */
        /* PRINT STYLES         */
        /* ==================== */
        @media print {
            .nav-tabs, button, .camera-permission {
                display: none !important;
            }

            .result-card {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }

        /* ==================== */
        /* BROWSER ENHANCEMENTS */
        /* ==================== */
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #2e7d32;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1b5e20;
        }

        /* ==================== */
        /* ENHANCED READABILITY */
        /* ==================== */

        /* Ensure good contrast for all text */
        .excel-details,
        .search-guide,
        .methodology-info,
        .result-box,
        .history-item,
        .product-info,
        .no-certs,
        .debug-info {
            color: #212529; /* Dark gray instead of pure black */
        }

        /* Make headings stand out */
        .excel-details h4,
        .search-guide h4,
        .methodology-info h4,
        .result-box h4,
        .history-item h4,
        .product-info h3,
        .product-info h4 {
            font-weight: 700 !important; /* Bold */
        }

        /* Fix specific colored headings */
        .excel-details h4 { color: #0d6efd !important; }
        .search-guide h4 { color: #2e7d32 !important; }
        .methodology-info h4 { color: #e65100 !important; }

        /* Ensure paragraph text has good contrast */
        .excel-details p,
        .search-guide p,
        .methodology-info p,
        .result-box p,
        .history-item p,
        .product-info p,
        .debug-info p,
        .no-certs p {
            color: #495057; /* Medium gray for better readability */
            font-weight: 400;
        }

        /* Fix the tip text */
        .search-guide .tip {
            color: #6c757d !important; /* Lighter gray for less important text */
            font-style: italic;
        }

        /* Keep badges with white text */
        .extraction-confidence {
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø TBL Scanner</h1>
            <p>Social ‚Ä¢ Environmental ‚Ä¢ Economic Impact</p>
            <!-- UPDATE 1: Version number updated from 2.1 to 2.3.0 -->
            <p class="subtitle">Consistent Certification Scoring v2.3.0</p>
            <div id="userStatus" class="user-info">Not logged in</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('scan-sec')">üì∑ Scan</button>
            <button class="nav-tab" onclick="switchTab('lookup-sec')">üîç Search</button>
            <button class="nav-tab" onclick="switchTab('excel-sec')">üìä Excel</button>
            <button class="nav-tab" onclick="switchTab('register-sec')">üìù Register</button>
            <button class="nav-tab" onclick="switchTab('login-sec')">üîê Login</button>
            <button class="nav-tab" onclick="switchTab('history-sec')">üìã History</button>
        </div>

        <div class="content">
            <div id="errorBox" class="error-msg"></div>
            <div id="successBox" class="success-msg"></div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Scanning...</p>
            </div>

            <!-- Scanner Section -->
            <div id="scan-sec" class="section active">
                <!-- Simplified scanner interface -->
                <div id="scanner-ui">
                    <div id="interactive" class="viewport">
                        <video id="scanner-video"></video>
                        <div class="scanner-overlay">
                            <div class="scanner-line"></div>
                            <div id="detectionIndicator" class="detection-indicator">üîç Detecting...</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="startScanner()" id="startScannerBtn">üé¨ Start Scanner</button>
                        <button onclick="stopScanner()" class="secondary">‚èπÔ∏è Stop Scanner</button>
                        <button onclick="testBarcodeScanner()" class="info" style="margin-top: 10px;">üß™ Test ZXing Scanner</button>
                    </div>
                </div>

                <div class="transparency-link">
                    <a href="#" onclick="showMethodology()">üìñ View Scoring Methodology</a>
                </div>

                <div class="debug-info" id="scannerDebug">
                    ZXing scanner status: Click "Start Scanner" to begin ‚Ä¢
                    <a href="#" onclick="checkScannerHealth()" style="color: #2e7d32; text-decoration: underline;">Check ZXing Scanner Health</a>
                </div>

                <!-- Test barcode images -->
                <div id="testBarcodes" style="display: none; margin-top: 20px; text-align: center;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">Test Barcodes</h4>
                    <p style="font-size: 14px; color: #666; margin-bottom: 10px;">Try scanning these test barcodes:</p>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="background: white; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6;">
                                <img src="https://barcode.tec-it.com/barcode.ashx?data=7613036925575&code=EAN13&dpi=96" alt="Test Barcode 1" style="width: 150px; height: 80px; object-fit: contain;">
                                <p style="font-size: 12px; margin-top: 5px;">7613036925575 (EAN-13)</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="background: white; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6;">
                                <img src="https://barcode.tec-it.com/barcode.ashx?data=9780140157376&code=EAN13&dpi=96" alt="Test Barcode 2" style="width: 150px; height: 80px; object-fit: contain;">
                                <p style="font-size: 12px; margin-top: 5px;">9780140157376 (EAN-13)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Lookup Section -->
            <div id="lookup-sec" class="section">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">üì¶ Barcode Lookup</h3>
                <input type="text" id="manualBarcode" placeholder="Enter Barcode (e.g., 7613036925575)">
                <button onclick="manualScan()">üîç Lookup by Barcode</button>

                <hr>

                <div class="search-guide">
                    <!-- UPDATE 2: Updated subtitle to reflect consistent scoring -->
                    <h4>üîç Consistent Scoring Across All Search Methods:</h4>
                    <p><strong>‚úÖ Single Scoring Function:</strong> Same brand always gets same score</p>
                    <p><strong>üîç Barcode Scan:</strong> Full product info ‚Üí Brand ‚Üí Consistent score</p>
                    <p><strong>üî§ Brand Search:</strong> Direct lookup ‚Üí Hardcoded/Excel score</p>
                    <p><strong>üìù Product Name:</strong> Brand extraction ‚Üí Same score as brand search</p>
                    <p class="tip">üí° Single scoring function ensures consistency across all search methods</p>
                </div>

                <h3 style="color: #2e7d32; margin-bottom: 10px;">üî§ Search by Brand Name</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Direct certification lookup for known brands</p>
                <input type="text" id="manualBrand" placeholder="Enter Brand Name (e.g., Hershey's, General Mills)">
                <button onclick="brandSearch()" class="secondary">üî§ Search by Brand</button>

                <div style="height: 20px;"></div>

                <h3 style="color: #2e7d32; margin-bottom: 10px;">üìù Search by Product Name</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">We'll extract the brand from product name automatically</p>
                <input type="text" id="manualProductName" placeholder="Enter Product Name (e.g., Oreo Chocolate Cookies)">
                <button onclick="productNameSearch()" class="secondary">üìù Search by Product Name</button>

                <div class="methodology-info">
                    <!-- UPDATE 3: Updated methodology section -->
                    <h4>üìä Consistent Scoring Methodology v2.3.0</h4>
                    <p>‚Ä¢ Base Score: 5.0 in each pillar</p>
                    <p>‚Ä¢ Hardcoded scores prioritized for consistency</p>
                    <p>‚Ä¢ Same brand ‚Üí Same score always (single scoring function)</p>
                    <p>‚Ä¢ Parent company mapping (Cheerios ‚Üí General Mills)</p>
                    <p>‚Ä¢ Multi-certification bonus automatically applied</p>
                    <button onclick="showMethodology()" class="info" style="margin-top: 10px;">üìñ View Full Methodology</button>
                </div>

                <hr>

                <h3 style="color: #2e7d32; margin-bottom: 15px;">üß™ Consistency Tests</h3>
                <!-- UPDATE 4: Added new test button for Dannon consistency -->
                <button onclick="testDannonConsistency()" class="test-button">Test Dannon Consistency</button>
                <button onclick="testBrandExtraction()" class="secondary">Test Brand Extraction</button>
                <button onclick="testScoringMethodology()" class="info">Test Nespresso Multi-Cert</button>

                <div class="debug-info" id="debugInfo">
                    Debug info will appear here
                </div>
            </div>

            <!-- Excel Status Section -->
            <div id="excel-sec" class="section">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">üìä Excel Certification System</h3>

                <div class="excel-details">
                    <h4>üìã About Excel System</h4>
                    <p>This app uses an Excel file as one source for certification data.</p>
                    <p><strong>Scoring Priority:</strong> Hardcoded DB ‚Üí Brand Synonyms ‚Üí Parent Company ‚Üí Excel DB</p>
                    <p><strong>Consistency:</strong> Single scoring function ensures identical results</p>
                </div>

                <button onclick="checkExcelStatus()" class="excel">üîÑ Check Excel Status</button>
                <button onclick="showExcelUpload()" class="secondary">üì§ Upload Excel File</button>
                <button onclick="verifyExcelScript()" class="info">üîß Verify Script</button>

                <div id="excelStatus" style="margin-top: 20px;"></div>

                <div id="excelUpload" style="display: none; margin-top: 20px;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">Upload New Excel File</h4>
                    <input type="file" id="excelFile" accept=".xlsx,.xls">
                    <button onclick="uploadExcelFile()" class="excel">üì§ Upload File</button>
                    <div id="uploadResult" style="margin-top: 10px;"></div>
                </div>

                <hr>

                <div class="excel-details">
                    <h4>üìã Excel Format Requirements</h4>
                    <p><strong>Required columns:</strong></p>
                    <ul style="font-size: 12px; padding-left: 20px;">
                        <li><code>brand</code> - Brand name</li>
                        <li><code>b_corp</code> - TRUE/FALSE</li>
                        <li><code>fair_trade</code> - TRUE/FALSE</li>
                        <li><code>rainforest_alliance</code> - TRUE/FALSE</li>
                        <li><code>leaping_bunny</code> - TRUE/FALSE</li>
                    </ul>
                    <p><strong>Optional columns:</strong> certification_date, certification_id, notes</p>
                </div>

                <div class="transparency-link">
                    <a href="#" onclick="showMethodology()">üìä View Complete Scoring Methodology</a>
                </div>
            </div>

            <!-- Registration Section -->
            <div id="register-sec" class="section">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">üìù Create New Account</h3>

                <input type="text" id="regUsername" placeholder="Username (min 3 characters)">
                <input type="email" id="regEmail" placeholder="Email address">
                <input type="password" id="regPassword" placeholder="Password (min 6 characters)">
                <input type="password" id="regConfirmPassword" placeholder="Confirm Password">

                <button onclick="registerUser()">üìù Create Account</button>

                <div id="registerResult" style="margin-top: 15px;"></div>

                <hr>

                <p style="text-align: center; color: #6c757d; font-size: 14px;">
                    Already have an account? <a href="#" onclick="switchTab('login-sec')" style="color: #2e7d32; font-weight: bold;">Click here to login</a>
                </p>
            </div>

            <!-- Login Section -->
            <div id="login-sec" class="section">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">üîê Login to Your Account</h3>

                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">

                <button onclick="loginUser()">üîê Login</button>

                <div id="loginResult" style="margin-top: 15px;"></div>

                <hr>

                <div class="excel-details" style="margin-top: 15px;">
                    <h4>Test Account</h4>
                    <p><strong>Username:</strong> Test123</p>
                    <p><strong>Password:</strong> Oranges</p>
                    <button onclick="useTestAccount()" class="secondary" style="margin-top: 10px;">Use Test Account</button>
                </div>
            </div>

            <!-- Purchase History Section -->
            <div id="history-sec" class="section">
                <h3 style="color: #2e7d32; margin-bottom: 15px;">üìã Purchase History</h3>

                <div id="historyStatus" class="result-box">
                    <p id="historyMessage">Login to view your purchase history</p>
                </div>

                <div id="historyContent" style="display: none;">
                    <div id="historyStats" class="excel-details" style="margin-bottom: 20px;"></div>
                    <div id="historyList"></div>
                    <button onclick="refreshHistory()" class="secondary">üîÑ Refresh History</button>
                </div>

                <hr>

                <div class="excel-details">
                    <h4>About Purchase History</h4>
                    <p>Your scanned products are automatically saved when you're logged in.</p>
                    <p>View your average TBL score and track your sustainable shopping habits.</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultCard" class="result-card">
                <div class="product-info">
                    <h3 id="brandName">Brand Name</h3>
                    <p id="productName" style="color: #6c757d; margin-bottom: 10px;">Product Name</p>
                    <p id="category" style="color: #6c757d; font-size: 14px;">Category</p>
                    <div id="extractionBadge" style="display: none; margin-top: 5px;"></div>
                </div>

                <div class="score-circle">
                    <span class="val" id="scoreVal">0.0</span>
                    <span class="label">TBL SCORE</span>
                    <div class="score-grade" id="gradeText">GRADE</div>
                </div>

                <div class="pillar">
                    <span>üë• Social Impact</span>
                    <span id="socScore">5.0</span>
                </div>
                <div class="pillar">
                    <span>üå± Environmental Impact</span>
                    <span id="envScore">5.0</span>
                </div>
                <div class="pillar">
                    <span>üí∞ Economic Impact</span>
                    <span id="econScore">5.0</span>
                </div>

                <!-- UPDATE 5: Added consistency badge -->
                <div style="text-align: center; margin: 10px 0;">
                    <span class="consistency-badge">‚úÖ Single Scoring Function Guarantees Consistency</span>
                </div>

                <div class="transparency-link" style="margin-top: 15px;">
                    <a href="#" onclick="showMethodologyForCurrentBrand()">üìä See how this score was calculated</a>
                </div>

                <div style="margin-top: 25px;">
                    <h4 style="color: #2e7d32; text-align: center; margin-bottom: 15px; font-size: 16px;">
                        ‚úÖ VERIFIED CERTIFICATIONS
                    </h4>
                    <div id="certsList" style="text-align: center;"></div>
                    <div id="noCerts" class="no-certs" style="display: none;">
                        No active certifications found for this brand
                    </div>

                    <div class="cert-source" id="certSource">
                        Source: Hardcoded Database + Excel Database ‚Ä¢ Base 5.0 + Certification Bonuses Only
                    </div>

                    <div class="cert-status" id="excelStatusInfo">
                        <span id="excelFoundStatus" class="excel-found">‚úì Found in Excel</span>
                        <span id="excelNotFoundStatus" class="excel-not-found" style="display: none;">‚úó Not in Excel</span>
                    </div>

                    <div id="excelDetails" class="excel-details" style="display: none;">
                        <h4>üìã Excel Details</h4>
                        <div id="excelDetailsContent"></div>
                    </div>

                    <div id="extractionInfo" class="excel-details" style="display: none; margin-top: 15px;">
                        <h4>üîç Brand Extraction Details</h4>
                        <div id="extractionDetailsContent"></div>
                    </div>
                </div>

                <div id="purchaseButtonContainer" style="margin-top: 15px;"></div>

                <button onclick="clearResults()" class="secondary" style="margin-top: 15px;">
                    üóëÔ∏è Clear Results
                </button>
            </div>
        </div>
    </div>
    <script>
        // ==================== //
        // GLOBAL VARIABLES     //
        // ==================== //
        let scannerActive = false;
        let codeReader = null;
        let currentStream = null;
        let currentUser = null;
        let authToken = null;
        let currentBrand = null; // FIX 1: Add missing currentBrand variable

        // ==================== //
        // ZXING SCANNER SETUP  //
        // ==================== //

        async function startScanner() {
            if (scannerActive) {
                stopScanner();
                return;
            }

            const videoElement = document.getElementById('scanner-video');
            if (!videoElement) {
                showMessage('error', 'Scanner video element not found');
                return;
            }

            debugLog("Initializing ZXing scanner...");

            try {
                // Check if ZXing is available
                if (typeof window.ZXing === 'undefined') {
                    throw new Error('ZXing library not loaded. Please refresh the page.');
                }

                // Log ZXing structure for debugging
                console.log('ZXing object:', window.ZXing);

                // Try different ways to find BrowserMultiFormatReader
                let BrowserMultiFormatReader;
                if (window.ZXing.BrowserMultiFormatReader) {
                    BrowserMultiFormatReader = window.ZXing.BrowserMultiFormatReader;
                    debugLog("Found BrowserMultiFormatReader in ZXing root");
                } else if (window.ZXing.browser && window.ZXing.browser.BrowserMultiFormatReader) {
                    BrowserMultiFormatReader = window.ZXing.browser.BrowserMultiFormatReader;
                    debugLog("Found BrowserMultiFormatReader in ZXing.browser");
                } else {
                    // Try to find it in the global scope
                    for (let key in window) {
                        if (key.includes('BrowserMultiFormatReader')) {
                            BrowserMultiFormatReader = window[key];
                            debugLog(`Found BrowserMultiFormatReader as ${key}`);
                            break;
                        }
                    }

                    if (!BrowserMultiFormatReader) {
                        throw new Error('BrowserMultiFormatReader not found in ZXing library');
                    }
                }

                // Create ZXing reader
                codeReader = new BrowserMultiFormatReader();
                debugLog("ZXing reader created successfully");

                // Get available video inputs
                let videoInputDevices = [];
                try {
                    videoInputDevices = await BrowserMultiFormatReader.listVideoInputDevices();
                    debugLog(`Found ${videoInputDevices.length} video devices`);
                } catch (deviceError) {
                    debugLog(`Warning: Could not list video devices: ${deviceError.message}`);
                    // Continue without device selection
                }

                // Get camera ID (use first available if we can't list devices)
                let selectedDeviceId = null;
                if (videoInputDevices.length > 0) {
                    // Try to find a rear-facing camera
                    const rearCamera = videoInputDevices.find(device =>
                        device.label && (
                            device.label.toLowerCase().includes('back') ||
                            device.label.toLowerCase().includes('rear') ||
                            device.label.toLowerCase().includes('environment')
                        )
                    );

                    if (rearCamera) {
                        selectedDeviceId = rearCamera.deviceId;
                        debugLog(`Selected rear camera: ${rearCamera.label}`);
                    } else {
                        selectedDeviceId = videoInputDevices[0].deviceId;
                        debugLog(`Selected first camera: ${videoInputDevices[0].label}`);
                    }
                }

                // Clear any previous video
                videoElement.srcObject = null;

                // Start decoding
                await codeReader.decodeFromVideoDevice(
                    selectedDeviceId,
                    'scanner-video',
                    async (result, error) => {
                        if (result) {
                            await handleBarcodeDetection(result.text, result.format);
                        }
                        if (error) {
                            // Don't show errors for NotFoundException (normal scanning)
                            if (!error || !error.message || !error.message.includes('NotFoundException')) {
                                debugLog(`Scanner error: ${error ? error.message : 'Unknown error'}`);
                            }
                        }
                    }
                );

                scannerActive = true;
                showMessage('success', 'ZXing scanner ready - point camera at barcode');
                debugLog("ZXing scanner started successfully");

                document.getElementById('scannerDebug').innerText = 'ZXing scanner status: Active - Scanning...';
                document.getElementById('scannerDebug').style.display = 'block';

                // Update UI
                const startBtn = document.getElementById('startScannerBtn');
                if (startBtn) {
                    startBtn.textContent = 'üîÑ Restart Scanner';
                    startBtn.classList.remove('scan-again');
                }

                // Show detection indicator
                const detectionIndicator = document.getElementById('detectionIndicator');
                if (detectionIndicator) {
                    detectionIndicator.style.display = 'block';
                    detectionIndicator.classList.add('detection-active');
                }

                // Show test barcodes
                document.getElementById('testBarcodes').style.display = 'block';

            } catch (error) {
                console.error('ZXing scanner init error:', error);
                console.error('Error stack:', error.stack);

                let errorMessage = 'ZXing Scanner error: ';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera permission denied. Please allow camera access in your browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera found on this device. Use manual barcode entry instead.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Camera is in use by another application. Close other camera apps.';
                } else if (error.message.includes('could not start video source')) {
                    errorMessage = 'ZXing camera error: Could not start video. Try closing other camera apps.';
                } else if (error.message.includes('BrowserMultiFormatReader') || error.message.includes('ZXing')) {
                    errorMessage = 'ZXing library error: ' + error.message + '\nTry refreshing the page or using a different browser.';
                } else if (error.message.includes('decode')) {
                    errorMessage = 'ZXing decoding error: ' + error.message;
                } else {
                    errorMessage = 'ZXing scanner error: ' + error.message;
                }

                showMessage('error', errorMessage);
                debugLog(`ZXing scanner error: ${error.message}`);

                // Update UI
                const startBtn = document.getElementById('startScannerBtn');
                if (startBtn) {
                    startBtn.textContent = 'üé¨ Start Scanner';
                    startBtn.disabled = false;
                }
            }
        }

        async function handleBarcodeDetection(code, format) {
            debugLog(`‚úÖ ZXing detected: ${code} (${format})`);

            // Show visual feedback immediately
            const detectionIndicator = document.getElementById('detectionIndicator');
            if (detectionIndicator) {
                detectionIndicator.innerHTML = `‚úÖ ZXing: ${format} - ${code}`;
                detectionIndicator.style.background = 'rgba(46, 125, 50, 0.9)';
            }

            // 1. STOP SCANNER IMMEDIATELY
            stopScanner();
            document.getElementById('scannerDebug').innerText = 'ZXing scanner status: Stopped (processing...)';

            // 2. Provide visual feedback
            showMessage('success', `‚úÖ ZXing scanned ${format}: ${code}`);

            // 3. Add visual feedback to scanner
            const scannerDiv = document.getElementById('interactive');
            scannerDiv.classList.add('scan-success');
            setTimeout(() => scannerDiv.classList.remove('scan-success'), 500);

            // 4. Show loading
            showLoading(true);

            try {
                // 5. FIRST: Look up barcode in Open Food Facts via backend
                debugLog(`Looking up barcode ${code} in Open Food Facts...`);
                showMessage('info', `Looking up product ${code}...`);

                const productResponse = await fetch(`${API_BASE}/product/${code}`);
                const productData = await productResponse.json();

                if (productData.found) {
                    // Found in Open Food Facts - use real product data
                    debugLog(`Found in Open Food Facts: ${productData.name} by ${productData.brand}`);
                    showMessage('success', `Found: ${productData.name}`);

                    const productPayload = {
                        barcode: code,
                        brand: productData.brand,
                        product_name: productData.name,
                        category: productData.category || "Unknown"
                    };

                    await processScan(productPayload, 'barcode');
                } else {
                    // Not found in Open Food Facts - ask user for product name
                    debugLog(`Not found in Open Food Facts for barcode ${code}`);
                    showMessage('info', 'Product not found. Please enter product name.');

                    // Hide scanner UI
                    document.getElementById('scanner-ui').style.display = 'none';

                    // Show product name input form
                    const productNameForm = `
                        <div id="productNameForm" style="margin-top: 20px;">
                            <h4 style="color: #2e7d32; margin-bottom: 10px;">Product Not Found in Database</h4>
                            <p style="color: #666; margin-bottom: 15px;">Barcode ${code} was not found in Open Food Facts. Please enter the product name:</p>
                            <input type="text" id="manualProductNameInput" placeholder="Enter product name (e.g., Oreo Chocolate Cookies)" style="width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #e9ecef; border-radius: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <button onclick="submitManualProductName('${code}')" style="flex: 1; padding: 15px; background: #2e7d32; color: white; border: none; border-radius: 10px; font-weight: bold;">Submit</button>
                                <button onclick="cancelManualEntry()" class="secondary" style="flex: 1; padding: 15px;">Cancel</button>
                            </div>
                        </div>
                    `;

                    document.getElementById('scan-sec').innerHTML += productNameForm;
                }

            } catch (error) {
                debugLog(`Error: ${error.message}`);
                showMessage('error', 'Lookup failed. Try manual entry or check backend connection.');

                // Fallback to simple payload with error note
                const payload = {
                    barcode: code,
                    brand: "Lookup Error",
                    product_name: `Product lookup failed for ${code}`,
                    category: "Error"
                };
                await processScan(payload, 'barcode');
            } finally {
                showLoading(false);
                // Reset detection indicator
                if (detectionIndicator) {
                    detectionIndicator.innerHTML = 'üîç Detecting...';
                    detectionIndicator.style.background = 'rgba(0, 0, 0, 0.7)';
                }
            }
        }

        // Helper function to submit manual product name
        function submitManualProductName(barcode) {
            const productName = document.getElementById('manualProductNameInput').value.trim();

            if (!productName) {
                showMessage('error', 'Please enter a product name');
                return;
            }

            // Remove the form
            document.getElementById('productNameForm').remove();

            // Show scanner UI again
            document.getElementById('scanner-ui').style.display = 'block';

            // Process with the manually entered product name
            const payload = {
                barcode: barcode,
                brand: "", // Let backend extract from product name
                product_name: productName,
                category: "General"
            };

            processScan(payload, 'barcode');
        }

        // Helper function to cancel manual entry
        function cancelManualEntry() {
            // Remove the form
            document.getElementById('productNameForm').remove();

            // Show scanner UI again
            document.getElementById('scanner-ui').style.display = 'block';

            // Reset scanner button
            const startBtn = document.getElementById('startScannerBtn');
            if (startBtn) {
                startBtn.textContent = 'üé¨ Start Scanner';
            }

            showMessage('info', 'Manual entry cancelled');
        }

        function testBarcodeScanner() {
            // Test barcodes with ZXing format info
            const testBarcodes = [
                {code: '7613036925575', format: 'EAN_13'}, // EAN-13 test
                {code: '9780140157376', format: 'EAN_13'}, // Book EAN-13 test
                {code: '1234567890128', format: 'EAN_13'}, // Valid EAN-13 checksum
                {code: '4006381333931', format: 'EAN_13'}  // Another valid EAN-13
            ];

            const randomBarcode = testBarcodes[Math.floor(Math.random() * testBarcodes.length)];

            // Simulate ZXing scanning process
            showMessage('info', `Testing ZXing scanner with ${randomBarcode.format}: ${randomBarcode.code}`);

            // If scanner is active, stop it first
            if (scannerActive) {
                stopScanner();
            }

            // Manually trigger the detection flow with Open Food Facts lookup
            showLoading(true);

            // Use the same flow as real scanning
            fetch(`${API_BASE}/product/${randomBarcode.code}`)
                .then(response => response.json())
                .then(productData => {
                    showLoading(false);

                    if (productData.found) {
                        showMessage('success', `Test: Found ${productData.name} by ${productData.brand}`);

                        const payload = {
                            barcode: randomBarcode.code,
                            brand: productData.brand,
                            product_name: productData.name,
                            category: productData.category || "Test"
                        };

                        processScan(payload, 'barcode');
                    } else {
                        showMessage('info', `Test: Product ${randomBarcode.code} not found. Using test product.`);

                        const payload = {
                            barcode: randomBarcode.code,
                            brand: "Test Brand",
                            product_name: "Test Product for ZXing Scanner",
                            category: "Test"
                        };

                        processScan(payload, 'barcode');
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showMessage('error', `Test failed: ${error.message}`);
                });
        }

        function stopScanner() {
            // Stop ZXing scanner
            if (codeReader && typeof codeReader.reset === 'function') {
                try {
                    codeReader.reset();
                    codeReader = null;
                } catch (error) {
                    debugLog(`Error stopping ZXing scanner: ${error.message}`);
                }
            }

            // Stop any active media stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
                currentStream = null;
            }

            // Clear video element
            const videoElement = document.getElementById('scanner-video');
            if (videoElement && videoElement.srcObject) {
                videoElement.srcObject = null;
            }

            scannerActive = false;
            debugLog("ZXing scanner stopped");

            // Update UI
            document.getElementById('scannerDebug').innerText = 'ZXing scanner status: Stopped';
            document.getElementById('scannerDebug').style.display = 'block';

            // Show restart button
            const startBtn = document.getElementById('startScannerBtn');
            if (startBtn) {
                startBtn.textContent = 'üé¨ Start Scanner';
                startBtn.classList.remove('scan-again');
                startBtn.disabled = false;
            }

            // Hide detection indicator
            const detectionIndicator = document.getElementById('detectionIndicator');
            if (detectionIndicator) {
                detectionIndicator.style.display = 'none';
            }

            // Hide test barcodes
            document.getElementById('testBarcodes').style.display = 'none';
        }

        // ==================== //
        // ORIGINAL APP LOGIC   //
        // ==================== //

        // Configure API base URL
        const API_BASE = (() => {
            // Try to detect if we're in development vs production
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Development - backend on port 8000
                return 'http://localhost:8000';
            } else {
                // Production - assume same origin
                return window.location.origin;
            }
        })();

        console.log(`API Base URL: ${API_BASE}`);

        // Debug logging
        function debugLog(message) {
            console.log(`[DEBUG] ${message}`);
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.innerHTML = message;
                debugDiv.style.display = 'block';
            }
        }

        // Tab switching
        function switchTab(id) {
            const event = window.event || arguments[0];

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(id).classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                const tabs = document.querySelectorAll('.nav-tab');
                tabs.forEach(tab => {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(id)) {
                        tab.classList.add('active');
                    }
                });
            }

            if(id !== 'scan-sec' && scannerActive) {
                stopScanner();
            }

            if (id === 'history-sec' && currentUser) {
                loadPurchaseHistory();
            }
        }

        // Update user status display
        function updateUserStatus() {
            const userStatus = document.getElementById('userStatus');
            if (currentUser) {
                userStatus.innerHTML = `üë§ ${currentUser} | <a href="#" onclick="logoutUser()">Logout</a>`;
                userStatus.style.display = 'block';

                document.getElementById('historyMessage').innerHTML =
                    `Welcome ${currentUser}! Click refresh to load your purchase history.`;
                document.getElementById('historyContent').style.display = 'block';
            } else {
                userStatus.innerHTML = 'Not logged in';
                document.getElementById('historyMessage').innerHTML =
                    'Please login to view your purchase history';
                document.getElementById('historyContent').style.display = 'none';
            }
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show/hide messages
        function showMessage(type, text) {
            const errorBox = document.getElementById('errorBox');
            const successBox = document.getElementById('successBox');

            if (type === 'error') {
                errorBox.innerText = text;
                errorBox.style.display = 'block';
                successBox.style.display = 'none';
            } else if (type === 'success') {
                successBox.innerText = text;
                successBox.style.display = 'block';
                errorBox.style.display = 'none';
            }

            setTimeout(() => {
                errorBox.style.display = 'none';
                successBox.style.display = 'none';
            }, 5000);
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('successBox').style.display = 'none';
        }

        // Register user
        async function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!username || !email || !password || !confirmPassword) {
                showMessage('error', 'All fields are required');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('error', 'Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showMessage('error', 'Password must be at least 6 characters');
                return;
            }

            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();
                showLoading(false);

                if (response.ok) {
                    document.getElementById('registerResult').innerHTML =
                        `<div style="color: #198754; background: #d1e7dd; padding: 10px; border-radius: 8px;">
                            ‚úÖ Account created successfully!<br>
                            Username: ${data.username}<br>
                            <a href="#" onclick="switchTab('login-sec')" style="color: #2e7d32; font-weight: bold;">Click here to login</a>
                        </div>`;

                    document.getElementById('regUsername').value = '';
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPassword').value = '';
                    document.getElementById('regConfirmPassword').value = '';
                } else {
                    throw new Error(data.detail || 'Registration failed');
                }
            } catch (err) {
                showLoading(false);
                document.getElementById('registerResult').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 10px; border-radius: 8px;">
                        ‚ùå Error: ${err.message}
                    </div>`;
            }
        }

        // Login user
        async function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showMessage('error', 'Username and password required');
                return;
            }

            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                showLoading(false);

                if (response.ok) {
                    currentUser = data.username;
                    authToken = data.token;

                    document.getElementById('loginResult').innerHTML =
                        `<div style="color: #198754; background: #d1e7dd; padding: 10px; border-radius: 8px;">
                            ‚úÖ Login successful! Welcome ${data.username}
                        </div>`;

                    updateUserStatus();

                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    setTimeout(() => switchTab('scan-sec'), 1500);
                } else {
                    throw new Error(data.detail || 'Login failed');
                }
            } catch (err) {
                showLoading(false);
                document.getElementById('loginResult').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 10px; border-radius: 8px;">
                        ‚ùå Error: ${err.message}
                    </div>`;
            }
        }

        // Use test account
        function useTestAccount() {
            document.getElementById('loginUsername').value = 'Test123';
            document.getElementById('loginPassword').value = 'Oranges';
            loginUser();
        }

        // Logout user
        function logoutUser() {
            currentUser = null;
            authToken = null;
            updateUserStatus();
            showMessage('success', 'Logged out successfully');
            switchTab('scan-sec');
        }

        // Process scan - Excel-based version
        async function processScan(payload, searchType = 'barcode') {
            showLoading(true);
            hideMessages();

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const safePayload = {
                barcode: payload.barcode || "",
                brand: payload.brand || "",
                product_name: payload.product_name || "Scanned Product",
                category: payload.category || "Unknown"
            };

            debugLog(`Sending ${searchType} payload: ${JSON.stringify(safePayload)}`);

            try {
                const response = await fetch(`${API_BASE}/scan`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(safePayload)
                });

                debugLog(`Response status: ${response.status}`);

                if (!response.ok) {
                    let errorText = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        debugLog(`Error details: ${JSON.stringify(errorData)}`);
                        errorText = errorData.detail || JSON.stringify(errorData);
                    } catch (e) {
                        errorText = await response.text();
                    }
                    throw new Error(errorText);
                }

                const data = await response.json();
                debugLog(`Success! Data received from Excel system`);
                showLoading(false);

                displayResults(data, searchType);

                if (searchType === 'barcode') {
                    showMessage('success', `Scanned barcode ${safePayload.barcode}`);
                } else if (searchType === 'brand') {
                    showMessage('success', `Found brand: ${data.brand}`);
                } else if (searchType === 'product') {
                    const confidence = data.brand_extraction_info?.confidence || 0;
                    showMessage('success', `Extracted brand "${data.brand}" from product name (${confidence}% confidence)`);
                }

            } catch (err) {
                showLoading(false);
                console.error('Full scan error:', err);
                debugLog(`Error: ${err.message}`);

                if (err.message.includes('422')) {
                    showMessage('error', 'Invalid data sent to server. Please check the format.');
                } else if (err.message.includes('Failed to fetch')) {
                    showMessage('error', 'Cannot connect to server. Make sure backend is running.');
                } else {
                    showMessage('error', 'Scan failed: ' + err.message);
                }
            }
        }

        // Display results with Excel info and extraction details
        function displayResults(data, searchType = 'barcode') {
            const resultCard = document.getElementById('resultCard');
            resultCard.style.display = 'block';
            resultCard.classList.add('showing');

            currentBrand = data.brand; // FIX 2: Now currentBrand is defined

            document.getElementById('brandName').innerText = data.brand || 'Unknown Brand';
            document.getElementById('productName').innerText = data.product_name || 'Unknown Product';
            document.getElementById('category').innerText = `Category: ${data.category || 'Unknown'}`;

            const extractionBadge = document.getElementById('extractionBadge');
            if (data.brand_extraction_info && data.brand_extraction_info.extracted_from_name) {
                const confidence = data.brand_extraction_info.confidence || 0;
                let confidenceClass = 'confidence-low';
                if (confidence >= 80) confidenceClass = 'confidence-high';
                else if (confidence >= 50) confidenceClass = 'confidence-medium';

                extractionBadge.innerHTML = `
                    <span class="brand-extraction-badge">Brand Extracted</span>
                    <span class="extraction-confidence ${confidenceClass}">${confidence}% confidence</span>
                `;
                extractionBadge.style.display = 'block';
            } else {
                extractionBadge.style.display = 'none';
            }

            document.getElementById('scoreVal').innerText = data.overall_tbl_score?.toFixed(1) || '0.0';
            document.getElementById('gradeText').innerText = data.grade || 'UNKNOWN';

            document.getElementById('socScore').innerText = data.social_score?.toFixed(1) || '5.0';
            document.getElementById('envScore').innerText = data.environmental_score?.toFixed(1) || '5.0';
            document.getElementById('econScore').innerText = data.economic_score?.toFixed(1) || '5.0';

            const certsDiv = document.getElementById('certsList');
            const noCertsDiv = document.getElementById('noCerts');
            const excelDetailsDiv = document.getElementById('excelDetails');
            const excelDetailsContent = document.getElementById('excelDetailsContent');
            const excelFoundStatus = document.getElementById('excelFoundStatus');
            const excelNotFoundStatus = document.getElementById('excelNotFoundStatus');
            const purchaseButtonContainer = document.getElementById('purchaseButtonContainer');
            const extractionInfoDiv = document.getElementById('extractionInfo');
            const extractionDetailsContent = document.getElementById('extractionDetailsContent');

            certsDiv.innerHTML = '';
            excelDetailsDiv.style.display = 'none';
            extractionInfoDiv.style.display = 'none';
            purchaseButtonContainer.innerHTML = '';

            let certifications = [];

            if (Array.isArray(data.certifications)) {
                certifications = data.certifications;
            } else if (data.certifications_detailed && typeof data.certifications_detailed === 'object') {
                certifications = Object.entries(data.certifications_detailed)
                    .filter(([_, value]) => value)
                    .map(([key, _]) => key.replace('_', ' ').toUpperCase());
            }

            if (certifications.length > 0) {
                certifications.forEach(cert => {
                    const certElement = document.createElement('span');
                    certElement.className = 'cert-tag';
                    certElement.innerText = `‚úì ${cert}`;
                    certsDiv.appendChild(certElement);
                });
                noCertsDiv.style.display = 'none';
            } else {
                noCertsDiv.style.display = 'block';
            }

            if (data.found_in_excel) {
                excelFoundStatus.style.display = 'inline';
                excelNotFoundStatus.style.display = 'none';

                if (data.excel_details) {
                    excelDetailsDiv.style.display = 'block';
                    let detailsHtml = '';

                    if (data.excel_details.original_brand) {
                        detailsHtml += `<strong>Original Brand:</strong> ${data.excel_details.original_brand}<br>`;
                    }
                    if (data.excel_details.certification_date) {
                        detailsHtml += `<strong>Certification Date:</strong> ${data.excel_details.certification_date}<br>`;
                    }
                    if (data.excel_details.certification_id) {
                        detailsHtml += `<strong>Certification ID:</strong> ${data.excel_details.certification_id}<br>`;
                    }
                    if (data.excel_details.notes) {
                        detailsHtml += `<strong>Notes:</strong> ${data.excel_details.notes}<br>`;
                    }

                    excelDetailsContent.innerHTML = detailsHtml || 'No additional details available.';
                }
            } else {
                excelFoundStatus.style.display = 'none';
                excelNotFoundStatus.style.display = 'inline';
            }

            document.getElementById('certSource').innerText = `Source: ${data.certification_source || 'Hardcoded Database + Excel Database'} ‚Ä¢ Base 5.0 + Certification Bonuses Only`;

            if (data.brand_extraction_info && data.brand_extraction_info.extracted_from_name) {
                extractionInfoDiv.style.display = 'block';
                let extractionHtml = '';
                const extractionInfo = data.brand_extraction_info;

                extractionHtml += `<p><strong>Search Method:</strong> Product Name ‚Üí Brand Extraction</p>`;
                extractionHtml += `<p><strong>Confidence Level:</strong> ${extractionInfo.confidence || 0}%</p>`;

                if (extractionInfo.warning) {
                    extractionHtml += `<p><strong>‚ö†Ô∏è Note:</strong> ${extractionInfo.warning}</p>`;
                }

                if (extractionInfo.alternative_brands && extractionInfo.alternative_brands.length > 0) {
                    extractionHtml += `<p><strong>Other possible brands:</strong> ${extractionInfo.alternative_brands.join(', ')}</p>`;
                }

                if (extractionInfo.search_results) {
                    extractionHtml += `<p><strong>Search Results:</strong> ${extractionInfo.search_results.total_products || 0} products found</p>`;
                }

                extractionDetailsContent.innerHTML = extractionHtml;
            }

            if (currentUser) {
                const purchaseButton = document.createElement('button');
                purchaseButton.className = 'danger';
                purchaseButton.innerHTML = 'üí∞ Save to Purchase History';
                purchaseButton.onclick = () => recordPurchase({
                    barcode: data.barcode,
                    brand: data.brand,
                    product_name: data.product_name,
                    category: data.category,
                    price: null
                });
                purchaseButtonContainer.appendChild(purchaseButton);
            }

            // Auto-scroll to results
            setTimeout(() => {
                resultCard.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        // Show scoring methodology
        function showMethodology() {
            window.open(`${API_BASE}/scoring-methodology`, '_blank');
        }

        // Show methodology for current brand
        function showMethodologyForCurrentBrand() {
            if (currentBrand) {
                window.open(`${API_BASE}/test/scoring/${encodeURIComponent(currentBrand)}`, '_blank');
            } else {
                showMethodology();
            }
        }

        // Record purchase
        async function recordPurchase(productData) {
            if (!currentUser) {
                showMessage('error', 'Please login to record purchases');
                return;
            }

            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/purchase?username=${currentUser}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();
                showLoading(false);

                if (response.ok) {
                    showMessage('success', 'Purchase recorded to your history');
                    const purchaseButton = document.querySelector('#purchaseButtonContainer button');
                    if (purchaseButton) {
                        purchaseButton.innerHTML = '‚úÖ Purchase Saved!';
                        purchaseButton.disabled = true;
                        purchaseButton.style.background = 'linear-gradient(135deg, #198754 0%, #157347 100%)';
                    }
                } else {
                    throw new Error(result.detail || 'Failed to record purchase');
                }
            } catch (err) {
                showLoading(false);
                showMessage('error', 'Failed to save purchase: ' + err.message);
            }
        }

        // Load purchase history
        async function loadPurchaseHistory() {
            if (!currentUser) {
                document.getElementById('historyStatus').innerHTML =
                    '<p style="color: #dc3545;">Please login to view your purchase history</p>';
                return;
            }

            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/history/${currentUser}?limit=20`);
                const data = await response.json();
                showLoading(false);

                if (response.ok) {
                    const statsDiv = document.getElementById('historyStats');
                    statsDiv.innerHTML = `
                        <h4>üìä Your Shopping Stats</h4>
                        <p><strong>Total Purchases:</strong> ${data.total_purchases}</p>
                        <p><strong>Average TBL Score:</strong> ${data.average_tbl_score}</p>
                    `;

                    const historyList = document.getElementById('historyList');
                    if (data.purchases && data.purchases.length > 0) {
                        let html = '<h4 style="color: #2e7d32; margin-bottom: 15px;">Recent Purchases:</h4>';
                        data.purchases.forEach(purchase => {
                            html += `
                                <div class="history-item">
                                    <div style="font-weight: bold; color: #2e7d32;">${purchase.brand}</div>
                                    <div style="color: #6c757d; font-size: 14px;">${purchase.product_name}</div>
                                    <div style="margin-top: 8px;">
                                        <span style="color: #495057;">TBL Score:</span>
                                        <span style="font-weight: bold; color: #2e7d32; margin-left: 10px;">${purchase.tbl_score}</span>
                                        <span style="margin-left: 15px; color: #6c757d; font-size: 12px;">${purchase.timestamp ? new Date(purchase.timestamp).toLocaleDateString() : ''}</span>
                                    </div>
                                    ${purchase.certifications && purchase.certifications.length > 0 ?
                                        `<div style="margin-top: 5px;">
                                            ${purchase.certifications.map(cert =>
                                                `<span style="background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 5px;">${cert}</span>`
                                            ).join('')}
                                        </div>` : ''
                                    }
                                </div>
                            `;
                        });
                        historyList.innerHTML = html;
                    } else {
                        historyList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No purchase history yet. Start scanning!</p>';
                    }
                } else {
                    throw new Error(data.detail || 'Failed to load history');
                }
            } catch (err) {
                showLoading(false);
                document.getElementById('historyStatus').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 10px; border-radius: 8px;">
                        ‚ùå Error loading history: ${err.message}
                    </div>`;
            }
        }

        // Refresh history
        function refreshHistory() {
            loadPurchaseHistory();
            showMessage('success', 'History refreshed');
        }

        // Clear results
        function clearResults() {
            document.getElementById('resultCard').style.display = 'none';
            hideMessages();
            currentBrand = null;

            document.getElementById('manualBarcode').value = '';
            document.getElementById('manualBrand').value = '';
            document.getElementById('manualProductName').value = '';

            showMessage('success', 'Results cleared');
        }

        // Manual scan by barcode
        function manualScan() {
            const barcode = document.getElementById('manualBarcode').value.trim();

            if (!barcode) {
                showMessage('error', 'Please enter a barcode');
                return;
            }

            const payload = {
                barcode: barcode,
                brand: "",
                product_name: `Barcode: ${barcode}`,
                category: ""
            };

            processScan(payload, 'barcode');
        }

        // Updated Brand Search with Web Discovery Fallback
                async function brandSearch() {
                    const brand = document.getElementById('manualBrand').value.trim();

                    if (!brand) {
                        showMessage('error', 'Please enter a brand name');
                        return;
                    }

                    showLoading(true);
                    clearResults();

                    try {
                        // Call the specific search-brand endpoint
                        const response = await fetch(`${API_URL}/search-brand?q=${encodeURIComponent(brand)}`);
                        const data = await response.json();

                        // Scenario A: Backend didn't find a local match, but found products on Open Food Facts
                        if (data.source === 'open_food_facts') {
                            renderDiscoveredProducts(data.discovered_products, data.message);
                        }
                        // Scenario B: Backend found a high-confidence match in your Excel/Hardcoded list
                        else if (data.success) {
                            displayResult(data);
                        }
                        else {
                            showMessage('error', data.message || 'Brand not found');
                        }
                    } catch (err) {
                        console.error('Search error:', err);
                        showMessage('error', 'Search failed. Check your connection.');
                    } finally {
                        showLoading(false);
                    }
                }

                // Add this helper to render the "Did you mean?" list from the web
                function renderDiscoveredProducts(products, message) {
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.style.display = 'block';

                    let html = `
                        <div class="search-guide" style="border-left: 4px solid #3498db; background: #ebf5ff; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2980b9; margin-bottom: 10px;">üîç ${message}</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;

                    products.forEach(p => {
                        html += `
                            <div class="result-box" onclick="quickScan('${p.barcode}')"
                                 style="cursor: pointer; background: white; padding: 10px; border: 1px solid #d1e2f3; border-radius: 6px; transition: transform 0.1s;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${p.image ? `<img src="${p.image}" style="height: 40px; width: 40px; object-fit: contain; border-radius: 4px;">` : ''}
                                    <div>
                                        <strong style="display: block; color: #2c3e50;">${p.name}</strong>
                                        <small style="color: #7f8c8d;">Brand: ${p.brand}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `</div><p class="tip" style="margin-top: 10px; font-size: 0.85em; color: #666;">Click a product to calculate its TBL score.</p></div>`;
                    resultsDiv.innerHTML = html;
                }

                // Helper to trigger a score lookup based on a selected web product
                async function quickScan(barcode) {
                    document.getElementById('manualBarcode').value = barcode;
                    manualScan();
                }

        // Product name search (extracts brand)
        function productNameSearch() {
            const productName = document.getElementById('manualProductName').value.trim();

            if (!productName) {
                showMessage('error', 'Please enter a product name');
                return;
            }

            const payload = {
                barcode: "",
                brand: "",
                product_name: productName,
                category: "General"
            };

            processScan(payload, 'product');
        }

        // FIX 3: Add missing testBrandExtraction function
        function testBrandExtraction() {
            const testProducts = [
                "Oreo Chocolate Sandwich Cookies",
                "Coca-Cola Classic 12oz",
                "Ben & Jerry's Chocolate Chip Cookie Dough Ice Cream",
                "Great Value Chocolate Chip Cookies",
                "Hershey's Milk Chocolate Bar",
                "Cheerios Original Cereal",
                "Tide Original Scent Laundry Detergent"
            ];

            const randomProduct = testProducts[Math.floor(Math.random() * testProducts.length)];

            document.getElementById('manualProductName').value = randomProduct;
            productNameSearch();
        }

        // NEW FUNCTION: Test Dannon consistency
        function testDannonConsistency() {
            window.open(`${API_BASE}/test/scoring/Dannon`, '_blank');
            showMessage('info', 'Testing Dannon consistency using scoring endpoint');
            debugLog('Testing Dannon consistency with existing backend endpoint');
        }

        // Test scoring methodology
        function testScoringMethodology() {
            window.open(`${API_BASE}/test/scoring/Nespresso`, '_blank');
        }

        // Check Excel status
        async function checkExcelStatus() {
            try {
                const response = await fetch(`${API_BASE}/certifications/status`);
                const data = await response.json();

                const statusDiv = document.getElementById('excelStatus');
                let html = `<div class="excel-details">
                    <h4>üìä Excel Database Status</h4>
                    <p><strong>File:</strong> ${data.excel_file}</p>
                    <p><strong>Status:</strong> <span style="color: ${data.status === 'success' ? '#198754' : '#dc3545'}">${data.status}</span></p>
                    <p><strong>Total Records:</strong> ${data.total_records || 0}</p>
                    <p><strong>Last Loaded:</strong> ${data.last_loaded || 'Never'}</p>`;

                if (data.sample_brands && data.sample_brands.length > 0) {
                    html += `<p><strong>Sample Brands:</strong> ${data.sample_brands.map(b => b.original_brand).join(', ')}</p>`;
                }

                html += `</div>`;
                statusDiv.innerHTML = html;

            } catch (err) {
                document.getElementById('excelStatus').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 15px; border-radius: 8px;">Error: ${err.message}</div>`;
            }
        }

        // Verify Excel script
        async function verifyExcelScript() {
            try {
                const response = await fetch(`${API_BASE}/certifications/verify-script`);
                const data = await response.json();

                const statusDiv = document.getElementById('excelStatus');
                let html = `<div class="excel-details">
                    <h4>üîß Script Verification</h4>
                    <p><strong>Script Status:</strong> ${data.script.exists ? 'Found' : 'Not Found'}</p>
                    <p><strong>Excel File:</strong> ${data.excel_file.exists ? 'Found' : 'Not Found'}</p>`;

                if (data.excel_file.data) {
                    if (data.excel_file.data.error) {
                        html += `<p><strong>Excel Data:</strong> Error: ${data.excel_file.data.error}</p>`;
                    } else {
                        html += `<p><strong>Rows/Columns:</strong> ${data.excel_file.data.rows} √ó ${data.excel_file.data.columns}</p>`;
                        html += `<p><strong>Columns:</strong> ${data.excel_file.data.columns_list.join(', ')}</p>`;
                    }
                }

                html += `</div>`;
                statusDiv.innerHTML = html;

            } catch (err) {
                document.getElementById('excelStatus').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 15px; border-radius: 8px;">Error: ${err.message}</div>`;
            }
        }

        // Show Excel upload form
        function showExcelUpload() {
            document.getElementById('excelUpload').style.display = 'block';
            document.getElementById('excelStatus').innerHTML = '';
        }

        // Upload Excel file
        async function uploadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('error', 'Please select an Excel file to upload');
                return;
            }

            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('error', 'Please select an Excel file (.xlsx or .xls)');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showLoading(true);
                const response = await fetch(`${API_BASE}/certifications/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                showLoading(false);

                if (response.ok) {
                    document.getElementById('uploadResult').innerHTML =
                        `<div style="color: #198754; background: #d1e7dd; padding: 10px; border-radius: 8px;">
                            ‚úÖ ${result.message}<br>
                            Total records: ${result.total_records}
                        </div>`;

                    checkExcelStatus();
                } else {
                    throw new Error(result.detail || 'Upload failed');
                }
            } catch (err) {
                showLoading(false);
                document.getElementById('uploadResult').innerHTML =
                    `<div style="color: #dc3545; background: #ffebee; padding: 10px; border-radius: 8px;">
                        ‚ùå Error: ${err.message}
                    </div>`;
            }
        }

        // Check scanner health
        function checkScannerHealth() {
            fetch(`${API_BASE}/scanner/health`)
                .then(response => response.json())
                .then(data => {
                    debugLog(`Scanner Health: ${data.scanner_system}`);
                    showMessage('success', `Scanner system: ${data.scanner_system}`);
                })
                .catch(err => {
                    debugLog('Scanner health check failed');
                    showMessage('info', 'Scanner health endpoint not available');
                });
        }

        // Auto-start on page load
        document.addEventListener('DOMContentLoaded', function() {
            debugLog("Page loaded. Testing API connection...");

            fetch(`${API_BASE}/health`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    debugLog(`API connected: ${data.status} - v${data.version}`);
                    showMessage('success', `Connected to consistent scoring system v${data.version}`);

                    // Log key backend info
                    debugLog(`Backend: ${data.total_brands} brands, ${data.hardcoded_scores} hardcoded scores`);
                })
                .catch(() => {
                    debugLog('Cannot connect to backend API');
                    showMessage('error', 'Cannot connect to backend API. Make sure it is running on port 8000.');
                });

            updateUserStatus();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && scannerActive) {
                stopScanner();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                if (document.getElementById('manualBarcode').value) {
                    manualScan();
                } else if (document.getElementById('manualBrand').value) {
                    brandSearch();
                } else if (document.getElementById('manualProductName').value) {
                    productNameSearch();
                }
            }
            if (e.key === 'Escape') {
                clearResults();
            }
        });
    </script>
</body>
</html>
