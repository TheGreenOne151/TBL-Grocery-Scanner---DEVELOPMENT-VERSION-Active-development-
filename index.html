<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBL Grocery Scanner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color palette with high contrast for accessibility */
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #ff9800;
            --secondary-dark: #e65100;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #212121;
            --text-secondary: #666666;
            --text-light: #ffffff;
            --border: #e0e0e0;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --info: #2196f3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
            --radius: 12px;
            --radius-small: 8px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* High contrast adjustments for accessibility */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #000000;
                --text-secondary: #333333;
                --border: #000000;
            }
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-light);
            padding: var(--spacing-lg) var(--spacing-md);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            font-size: 24px;
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 20px;
        }

        .logo-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .nav-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        /* Main container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            padding: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            background: var(--card-bg);
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: rgba(46, 125, 50, 0.05);
        }

        .tab:hover {
            background-color: rgba(46, 125, 50, 0.1);
        }

        /* Tab content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
            color: var(--primary);
        }

        .card-header i {
            margin-right: var(--spacing-sm);
            font-size: 20px;
        }

        .card-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 18px;
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-small);
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-small);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-light);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.3);
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Scanner */
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto var(--spacing-lg);
            border-radius: var(--radius);
            overflow: hidden;
            background: #000;
        }

        #scanner-video {
            width: 100%;
            height: auto;
            display: block;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        .scanner-frame {
            width: 250px;
            height: 150px;
            border: 3px solid var(--primary-light);
            border-radius: 8px;
            margin-bottom: var(--spacing-md);
        }

        /* Results */
        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .score-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .score-pillar {
            background: var(--background);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            text-align: center;
            border: 2px solid var(--border);
        }

        .pillar-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .pillar-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .overall-score {
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--text-light);
            padding: var(--spacing-lg);
            border-radius: var(--radius);
            margin: var(--spacing-lg) 0;
        }

        .overall-value {
            font-size: 48px;
            font-weight: 700;
            margin: var(--spacing-xs) 0;
        }

        .grade-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 18px;
            background: var(--text-light);
            margin-top: var(--spacing-sm);
        }

        .grade-excellent { color: #155724; background: #d4edda; }
        .grade-great { color: #0c5460; background: #d1ecf1; }
        .grade-good { color: #856404; background: #fff3cd; }
        .grade-poor { color: #721c24; background: #f8d7da; }

        .certifications-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .cert-badge {
            display: inline-block;
            padding: 6px 12px;
            background: var(--primary);
            color: var(--text-light);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .cert-badge.fair-trade { background: #e57373; }
        .cert-badge.rainforest { background: #81c784; }
        .cert-badge.leaping-bunny { background: #ffb74d; }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: var(--spacing-md);
            border-radius: var(--radius-small);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-xs) var(--spacing-sm);
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 12px;
            transition: color 0.3s ease;
            flex: 1;
            max-width: 100px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Comparison */
        .comparison-item {
            background: var(--background);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid var(--primary);
        }

        .add-brand-btn {
            background: none;
            border: 2px dashed var(--border);
            color: var(--text-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            margin-top: var(--spacing-sm);
            transition: all 0.3s ease;
        }

        .add-brand-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: var(--spacing-lg) var(--spacing-md);
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border);
            margin-top: var(--spacing-xl);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .score-display {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .pillar-value {
                font-size: 28px;
            }

            .overall-value {
                font-size: 36px;
            }

            .card {
                padding: var(--spacing-md);
            }
        }

        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: var(--spacing-sm);
            }

            .logo-text {
                font-size: 18px;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: var(--spacing-sm); }
        .mt-2 { margin-top: var(--spacing-md); }
        .mt-3 { margin-top: var(--spacing-lg); }
        .mb-1 { margin-bottom: var(--spacing-sm); }
        .mb-2 { margin-bottom: var(--spacing-md); }
        .mb-3 { margin-bottom: var(--spacing-lg); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">ðŸŒ¿</div>
                <div>
                    <div class="logo-text">TBL Grocery Scanner</div>
                    <div class="logo-subtitle">Triple Bottom Line Sustainability</div>
                </div>
            </div>
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="scan">Scan</button>
            <button class="tab" data-tab="search">Search</button>
            <button class="tab" data-tab="compare">Compare</button>
            <button class="tab" data-tab="info">Info</button>
        </div>

        <!-- Scan Tab -->
        <div id="scan-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-barcode"></i>
                    <h2 class="card-title">Scan Product Barcode</h2>
                </div>

                <div class="scanner-container hidden" id="scannerContainer">
                    <video id="scanner-video" playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                        <p>Align barcode within frame</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Or Enter Barcode Manually</label>
                    <input type="text" class="form-input" id="barcodeInput" placeholder="e.g., 012345678912" maxlength="13">
                </div>

                <div class="form-group">
                    <button class="btn btn-primary btn-full" id="startScanBtn">
                        <i class="fas fa-camera"></i> Start Camera Scanner
                    </button>
                </div>

                <div class="form-group">
                    <button class="btn btn-secondary btn-full" id="scanBtn">
                        <i class="fas fa-search"></i> Scan Barcode
                    </button>
                </div>
            </div>

            <div class="results-container" id="scanResults">
                <!-- Results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Search Tab -->
        <div id="search-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-search"></i>
                    <h2 class="card-title">Search by Product or Brand</h2>
                </div>

                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-input" id="productNameInput" placeholder="e.g., Oreo Cookies, Cheerios">
                </div>

                <div class="form-group">
                    <label class="form-label">Or Brand Name</label>
                    <input type="text" class="form-input" id="brandNameInput" placeholder="e.g., Nestle, Kraft Heinz">
                </div>

                <div class="form-group">
                    <button class="btn btn-primary btn-full" id="searchBtn">
                        <i class="fas fa-search"></i> Search Product/Brand
                    </button>
                </div>
            </div>

            <div class="results-container" id="searchResults">
                <!-- Search results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Compare Tab -->
        <div id="compare-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-balance-scale"></i>
                    <h2 class="card-title">Compare Brands</h2>
                </div>

                <div id="comparisonBrands">
                    <div class="form-group">
                        <label class="form-label">Brand 1</label>
                        <input type="text" class="form-input comparison-brand" placeholder="e.g., Nespresso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brand 2</label>
                        <input type="text" class="form-input comparison-brand" placeholder="e.g., Starbucks">
                    </div>
                </div>

                <button class="add-brand-btn" id="addBrandBtn">
                    <i class="fas fa-plus"></i> Add Another Brand
                </button>

                <div class="form-group mt-2">
                    <button class="btn btn-primary btn-full" id="compareBtn">
                        <i class="fas fa-chart-bar"></i> Compare Brands
                    </button>
                </div>
            </div>

            <div class="results-container" id="compareResults">
                <!-- Comparison results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Info Tab -->
        <div id="info-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i>
                    <h2 class="card-title">About TBL Scoring</h2>
                </div>
                <p>TBL (Triple Bottom Line) scoring evaluates brands based on three pillars:</p>

                <div class="score-display mt-2">
                    <div class="score-pillar">
                        <div class="pillar-name">ðŸ‘¥ Social</div>
                        <div class="pillar-value">5.0+</div>
                        <div>Fair labor, community impact</div>
                    </div>
                    <div class="score-pillar">
                        <div class="pillar-name">ðŸŒ± Environmental</div>
                        <div class="pillar-value">5.0+</div>
                        <div>Sustainability, eco-practices</div>
                    </div>
                    <div class="score-pillar">
                        <div class="pillar-name">ðŸ’° Economic</div>
                        <div class="pillar-value">5.0+</div>
                        <div>Ethical business practices</div>
                    </div>
                </div>

                <div class="alert alert-info mt-2">
                    <i class="fas fa-lightbulb"></i>
                    <div>All brands start with a base score of 5.0. Points are added for verified certifications like B Corp, Fair Trade, Rainforest Alliance, and Leaping Bunny.</div>
                </div>

                <div class="form-group mt-2">
                    <button class="btn btn-secondary btn-full" id="methodologyBtn">
                        <i class="fas fa-book"></i> View Full Methodology
                    </button>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary btn-full" id="healthBtn">
                        <i class="fas fa-heartbeat"></i> Check System Health
                    </button>
                </div>
            </div>

            <div class="card mt-2">
                <div class="card-header">
                    <i class="fas fa-database"></i>
                    <h2 class="card-title">Certification Database</h2>
                </div>
                <p>Our database includes certification status for hundreds of brands across 18 product categories.</p>

                <div class="form-group mt-2">
                    <button class="btn btn-secondary btn-full" id="certStatusBtn">
                        <i class="fas fa-database"></i> Check Certification Status
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading hidden" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Processing your request...</p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-tab="scan">
            <i class="fas fa-camera nav-icon"></i>
            <span>Scan</span>
        </a>
        <a href="#" class="nav-item" data-tab="search">
            <i class="fas fa-search nav-icon"></i>
            <span>Search</span>
        </a>
        <a href="#" class="nav-item" data-tab="compare">
            <i class="fas fa-balance-scale nav-icon"></i>
            <span>Compare</span>
        </a>
        <a href="#" class="nav-item" data-tab="info">
            <i class="fas fa-info-circle nav-icon"></i>
            <span>Info</span>
        </a>
    </nav>

    <script>
        // Global state
        const state = {
            currentTab: 'scan',
            scannerActive: false,
            mediaStream: null,
            currentResults: null
        };

        // DOM Elements
        const elements = {
            // Tabs
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            navItems: document.querySelectorAll('.nav-item'),

            // Scan tab
            scannerContainer: document.getElementById('scannerContainer'),
            scannerVideo: document.getElementById('scanner-video'),
            barcodeInput: document.getElementById('barcodeInput'),
            startScanBtn: document.getElementById('startScanBtn'),
            scanBtn: document.getElementById('scanBtn'),
            scanResults: document.getElementById('scanResults'),

            // Search tab
            productNameInput: document.getElementById('productNameInput'),
            brandNameInput: document.getElementById('brandNameInput'),
            searchBtn: document.getElementById('searchBtn'),
            searchResults: document.getElementById('searchResults'),

            // Compare tab
            comparisonBrands: document.getElementById('comparisonBrands'),
            addBrandBtn: document.getElementById('addBrandBtn'),
            compareBtn: document.getElementById('compareBtn'),
            compareResults: document.getElementById('compareResults'),

            // Info tab
            methodologyBtn: document.getElementById('methodologyBtn'),
            healthBtn: document.getElementById('healthBtn'),
            certStatusBtn: document.getElementById('certStatusBtn'),

            // Common
            loadingIndicator: document.getElementById('loadingIndicator'),
            alertContainer: document.getElementById('alertContainer'),
            navToggle: document.getElementById('navToggle')
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkBackendHealth();
        });

        // Setup all event listeners
        function setupEventListeners() {
            // Tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            elements.navItems.forEach(navItem => {
                navItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(navItem.dataset.tab);
                });
            });

            // Scan tab
            elements.startScanBtn.addEventListener('click', toggleScanner);
            elements.scanBtn.addEventListener('click', scanBarcode);
            elements.barcodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') scanBarcode();
            });

            // Search tab
            elements.searchBtn.addEventListener('click', searchProduct);
            elements.productNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchProduct();
            });
            elements.brandNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchProduct();
            });

            // Compare tab
            elements.addBrandBtn.addEventListener('click', addBrandField);
            elements.compareBtn.addEventListener('click', compareBrands);

            // Info tab
            elements.methodologyBtn.addEventListener('click', viewMethodology);
            elements.healthBtn.addEventListener('click', checkBackendHealth);
            elements.certStatusBtn.addEventListener('click', checkCertificationStatus);

            // Navigation toggle
            if (elements.navToggle) {
                elements.navToggle.addEventListener('click', toggleNavigation);
            }
        }

        // Switch between tabs
        function switchTab(tabId) {
            // Update active tab
            elements.tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });

            elements.tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}-tab`);
            });

            elements.navItems.forEach(navItem => {
                navItem.classList.toggle('active', navItem.dataset.tab === tabId);
            });

            // Stop scanner if switching away from scan tab
            if (tabId !== 'scan' && state.scannerActive) {
                toggleScanner();
            }

            // Update state
            state.currentTab = tabId;

            // Clear results when switching tabs (except when going back to scan with results)
            if (tabId !== 'scan' || !state.currentResults) {
                clearResults();
            } else if (tabId === 'scan' && state.currentResults) {
                // If we have results and are going back to scan tab, show them
                displayResults(state.currentResults, elements.scanResults);
            }
        }

        // Toggle scanner camera
        async function toggleScanner() {
            if (!state.scannerActive) {
                // Start scanner
                try {
                    state.mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });

                    elements.scannerVideo.srcObject = state.mediaStream;
                    elements.scannerContainer.classList.remove('hidden');
                    elements.startScanBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Camera';
                    state.scannerActive = true;

                    // Set up barcode detection (simplified - in a real app you'd use a library like ZXing)
                    setupBarcodeDetection();

                    showAlert('Camera started. Point at barcode to scan.', 'success');
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    showAlert('Could not access camera. Please check permissions.', 'error');
                }
            } else {
                // Stop scanner
                if (state.mediaStream) {
                    state.mediaStream.getTracks().forEach(track => track.stop());
                    state.mediaStream = null;
                }

                elements.scannerVideo.srcObject = null;
                elements.scannerContainer.classList.add('hidden');
                elements.startScanBtn.innerHTML = '<i class="fas fa-camera"></i> Start Camera Scanner';
                state.scannerActive = false;
            }
        }

        // Simplified barcode detection (for demo)
        function setupBarcodeDetection() {
            // In a real implementation, you would use a barcode scanning library
            // For this demo, we'll simulate detection when user clicks scan button
            console.log('Barcode detection would be set up here with a library like ZXing');
        }

        // Scan barcode (manual or via camera)
        async function scanBarcode() {
            const barcode = elements.barcodeInput.value.trim();

            if (!barcode && !state.scannerActive) {
                showAlert('Please enter a barcode or start the camera scanner.', 'error');
                return;
            }

            // For demo purposes, if camera is active, simulate a scanned barcode
            let scannedBarcode = barcode;
            if (state.scannerActive && !barcode) {
                // Simulate scanning a barcode (in real app, this would come from the scanner)
                scannedBarcode = '7613034627294'; // Example barcode
                elements.barcodeInput.value = scannedBarcode;
                showAlert('Simulated scan. In production, this would be a real barcode.', 'info');
            }

            if (!scannedBarcode) {
                showAlert('Please enter a barcode to scan.', 'error');
                return;
            }

            // Validate barcode format (simple check)
            if (!/^\d{8,13}$/.test(scannedBarcode)) {
                showAlert('Please enter a valid 8-13 digit barcode.', 'error');
                return;
            }

            showLoading();

            try {
                // Call the backend API
                const response = await fetch(`/product/${scannedBarcode}`);
                const data = await response.json();

                hideLoading();

                if (data.success === false && data.error) {
                    showAlert(`Scan failed: ${data.error}`, 'error');
                    return;
                }

                // Store results and display
                state.currentResults = data;
                displayResults(data, elements.scanResults);

            } catch (error) {
                hideLoading();
                console.error('Scan error:', error);
                showAlert('Failed to scan product. Please try again.', 'error');
            }
        }

        // Search for product or brand
        async function searchProduct() {
            const productName = elements.productNameInput.value.trim();
            const brandName = elements.brandNameInput.value.trim();

            if (!productName && !brandName) {
                showAlert('Please enter a product name or brand name to search.', 'error');
                return;
            }

            showLoading();

            try {
                let data;

                if (brandName) {
                    // Search by brand name
                    const response = await fetch('/scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            barcode: '',
                            brand: brandName,
                            product_name: '',
                            category: ''
                        })
                    });
                    data = await response.json();
                } else {
                    // Extract brand from product name
                    const extractResponse = await fetch('/extract-brand', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_name: productName,
                            max_results: 10
                        })
                    });

                    const extractData = await extractResponse.json();

                    if (extractData.result.success) {
                        // Now get scores for the extracted brand
                        const brand = extractData.result.extracted_brand;
                        const scanResponse = await fetch('/scan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                barcode: '',
                                brand: brand,
                                product_name: productName,
                                category: ''
                            })
                        });
                        data = await scanResponse.json();
                        data.brand_extraction_info = extractData.result;
                    } else {
                        hideLoading();
                        showAlert(`Could not identify brand: ${extractData.result.message}`, 'error');
                        return;
                    }
                }

                hideLoading();

                if (data.success === false && data.error) {
                    showAlert(`Search failed: ${data.error}`, 'error');
                    return;
                }

                displayResults(data, elements.searchResults);

            } catch (error) {
                hideLoading();
                console.error('Search error:', error);
                showAlert('Failed to search. Please try again.', 'error');
            }
        }

        // Add another brand field for comparison
        function addBrandField() {
            const brandCount = elements.comparisonBrands.children.length + 1;

            const newField = document.createElement('div');
            newField.className = 'form-group';
            newField.innerHTML = `
                <label class="form-label">Brand ${brandCount}</label>
                <input type="text" class="form-input comparison-brand" placeholder="e.g., General Mills">
                <button class="btn btn-secondary mt-1 remove-brand-btn" style="width: 100%; padding: 8px;">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;

            elements.comparisonBrands.appendChild(newField);

            // Add event listener to remove button
            newField.querySelector('.remove-brand-btn').addEventListener('click', function() {
                elements.comparisonBrands.removeChild(newField);
                // Renumber remaining brands
                renumberBrandFields();
            });
        }

        // Renumber brand fields after removal
        function renumberBrandFields() {
            const brandFields = elements.comparisonBrands.querySelectorAll('.form-group');
            brandFields.forEach((field, index) => {
                const label = field.querySelector('.form-label');
                if (label) {
                    label.textContent = `Brand ${index + 1}`;
                }
            });
        }

        // Compare multiple brands
        async function compareBrands() {
            const brandInputs = document.querySelectorAll('.comparison-brand');
            const brands = [];

            brandInputs.forEach(input => {
                const brand = input.value.trim();
                if (brand) {
                    brands.push({ brand: brand });
                }
            });

            if (brands.length < 2) {
                showAlert('Please enter at least 2 brands to compare.', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(brands)
                });

                const data = await response.json();
                hideLoading();

                displayComparisonResults(data.comparison, elements.compareResults);

            } catch (error) {
                hideLoading();
                console.error('Comparison error:', error);
                showAlert('Failed to compare brands. Please try again.', 'error');
            }
        }

        // View scoring methodology
        function viewMethodology() {
            window.open('/scoring-methodology', '_blank');
        }

        // Check backend health
        async function checkBackendHealth() {
            showLoading();

            try {
                const response = await fetch('/health');
                const data = await response.json();

                hideLoading();

                // Create a health report
                let healthHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Backend Status: ${data.status.toUpperCase()}</strong><br>
                            Version: ${data.version}<br>
                            Users: ${data.total_users}<br>
                            Hardcoded Brands: ${data.hardcoded_scores}<br>
                            Certification System: ${data.certification_system}
                        </div>
                    </div>
                `;

                // Add Excel file status
                if (data.excel_file_status === 'found') {
                    healthHtml += `
                        <div class="alert alert-info">
                            <i class="fas fa-file-excel"></i>
                            <div>
                                <strong>Excel Database Loaded</strong><br>
                                File: ${data.excel_file}<br>
                                Records: ${data.excel_records || 'Unknown'}<br>
                                Size: ${(data.excel_file_size / 1024).toFixed(2)} KB
                            </div>
                        </div>
                    `;
                } else {
                    healthHtml += `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Excel Database Not Found</strong><br>
                                File: ${data.excel_file}<br>
                                Please run the create-excel script.
                            </div>
                        </div>
                    `;
                }

                showAlert(healthHtml, 'info', false); // false means don't auto-hide

            } catch (error) {
                hideLoading();
                showAlert('Could not connect to backend. Please check if server is running.', 'error');
            }
        }

        // Check certification database status
        async function checkCertificationStatus() {
            showLoading();

            try {
                const response = await fetch('/certifications/status');
                const data = await response.json();

                hideLoading();

                let statusHtml = '';

                if (data.status === 'success') {
                    statusHtml = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Certification Database Loaded</strong><br>
                                Total Records: ${data.total_records}<br>
                                Last Loaded: ${new Date(data.last_loaded).toLocaleString()}<br>
                                File: ${data.excel_file}
                            </div>
                        </div>
                    `;

                    // Show sample brands
                    if (data.sample_brands && data.sample_brands.length > 0) {
                        statusHtml += '<div class="card mt-2"><div class="card-header"><h3 class="card-title">Sample Brands</h3></div><div class="certifications-list">';

                        data.sample_brands.forEach(brand => {
                            const certs = Object.entries(brand.certifications)
                                .filter(([key, value]) => value)
                                .map(([key]) => key.replace('_', ' '))
                                .join(', ');

                            statusHtml += `
                                <div class="comparison-item mt-1">
                                    <strong>${brand.original_brand}</strong><br>
                                    <small>Certifications: ${certs || 'None'}</small>
                                </div>
                            `;
                        });

                        statusHtml += '</div></div>';
                    }
                } else {
                    statusHtml = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Certification Database Not Loaded</strong><br>
                                ${data.message || 'Unknown error'}
                            </div>
                        </div>
                    `;
                }

                showAlert(statusHtml, 'info', false);

            } catch (error) {
                hideLoading();
                showAlert('Failed to check certification status.', 'error');
            }
        }

        // Display results from scan/search
        function displayResults(data, container) {
            // Clear previous results
            container.innerHTML = '';
            container.classList.remove('active');

            if (!data || data.success === false) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>No results found or an error occurred.</div>
                    </div>
                `;
                container.classList.add('active');
                return;
            }

            // Determine grade class
            let gradeClass = 'grade-poor';
            if (data.grade === 'EXCELLENT') gradeClass = 'grade-excellent';
            else if (data.grade === 'GREAT') gradeClass = 'grade-great';
            else if (data.grade === 'GOOD') gradeClass = 'grade-good';

            // Create certifications badges HTML
            let certBadgesHtml = '';
            if (data.certifications && data.certifications.length > 0) {
                data.certifications.forEach(cert => {
                    let certClass = 'cert-badge';
                    if (cert.includes('Fair Trade')) certClass += ' fair-trade';
                    else if (cert.includes('Rainforest')) certClass += ' rainforest';
                    else if (cert.includes('Leaping Bunny')) certClass += ' leaping-bunny';

                    certBadgesHtml += `<span class="${certClass}">${cert}</span>`;
                });
            } else {
                certBadgesHtml = '<p><em>No verified certifications found</em></p>';
            }

            // Check if brand was extracted from product name
            let extractionInfoHtml = '';
            if (data.brand_extraction_info && data.brand_extraction_info.extracted_from_name) {
                extractionInfoHtml = `
                    <div class="alert alert-info mt-2">
                        <i class="fas fa-lightbulb"></i>
                        <div>
                            <strong>Brand extracted from product name</strong><br>
                            Confidence: ${data.brand_extraction_info.confidence || 0}%<br>
                            Method: ${data.brand_extraction_info.method || 'Unknown'}
                        </div>
                    </div>
                `;
            }

            // Create results HTML
            const resultsHtml = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-check-circle"></i>
                        <h2 class="card-title">Scan Results</h2>
                    </div>

                    <div class="text-center mb-3">
                        <h3 style="color: var(--primary);">${data.brand || 'Unknown Brand'}</h3>
                        <p>${data.product_name || 'Product name not available'}</p>
                        ${data.category ? `<p><small>Category: ${data.category}</small></p>` : ''}
                        ${data.barcode ? `<p><small>Barcode: ${data.barcode}</small></p>` : ''}
                    </div>

                    ${extractionInfoHtml}

                    <div class="score-display">
                        <div class="score-pillar">
                            <div class="pillar-name">ðŸ‘¥ Social</div>
                            <div class="pillar-value">${data.social_score?.toFixed(1) || '0.0'}</div>
                            <div>Impact on people</div>
                        </div>
                        <div class="score-pillar">
                            <div class="pillar-name">ðŸŒ± Environmental</div>
                            <div class="pillar-value">${data.environmental_score?.toFixed(1) || '0.0'}</div>
                            <div>Planet impact</div>
                        </div>
                        <div class="score-pillar">
                            <div class="pillar-name">ðŸ’° Economic</div>
                            <div class="pillar-value">${data.economic_score?.toFixed(1) || '0.0'}</div>
                            <div>Business ethics</div>
                        </div>
                    </div>

                    <div class="overall-score">
                        <div>Overall TBL Score</div>
                        <div class="overall-value">${data.overall_tbl_score?.toFixed(1) || '0.0'}</div>
                        <div class="grade-badge ${gradeClass}">${data.grade || 'UNKNOWN'}</div>
                    </div>

                    <div class="mt-3">
                        <h4>Certifications</h4>
                        <div class="certifications-list">
                            ${certBadgesHtml}
                        </div>
                        <p class="mt-1"><small>Scoring Method: ${data.scoring_method || 'Unknown'}</small></p>
                        ${data.notes ? `<p class="mt-1"><small>${data.notes}</small></p>` : ''}
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-secondary btn-full" onclick="viewScoreBreakdown('${data.brand || ''}')">
                            <i class="fas fa-chart-line"></i> View Score Breakdown
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = resultsHtml;
            container.classList.add('active');
        }

        // Display comparison results
        function displayComparisonResults(comparisonData, container) {
            // Clear previous results
            container.innerHTML = '';
            container.classList.remove('active');

            if (!comparisonData || comparisonData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>No comparison results available.</div>
                    </div>
                `;
                container.classList.add('active');
                return;
            }

            // Sort by overall score (descending)
            const sortedData = [...comparisonData].sort((a, b) => b.overall_score - a.overall_score);

            let comparisonHtml = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i>
                        <h2 class="card-title">Brand Comparison</h2>
                    </div>

                    <div class="text-center mb-3">
                        <h3 style="color: var(--primary);">${sortedData.length} Brands Compared</h3>
                        <p>Ranked by overall TBL score</p>
                    </div>
            `;

            // Create comparison chart (simplified)
            sortedData.forEach((brand, index) => {
                // Determine grade class
                let gradeClass = 'grade-poor';
                if (brand.grade === 'EXCELLENT') gradeClass = 'grade-excellent';
                else if (brand.grade === 'GREAT') gradeClass = 'grade-great';
                else if (brand.grade === 'GOOD') gradeClass = 'grade-good';

                // Create a simple bar for visualization
                const barWidth = Math.min(100, (brand.overall_score / 10) * 100);

                comparisonHtml += `
                    <div class="comparison-item ${index === 0 ? 'mt-2' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${index + 1}. ${brand.brand}</strong>
                                <div class="grade-badge ${gradeClass}" style="font-size: 12px; padding: 4px 10px; margin-top: 4px;">
                                    ${brand.grade}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);">
                                    ${brand.overall_score.toFixed(1)}
                                </div>
                                <small>Overall Score</small>
                            </div>
                        </div>

                        <div style="margin: 10px 0; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${barWidth}%; height: 100%; background: var(--primary);"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                            <div style="text-align: center;">
                                <div style="font-weight: bold;">${brand.social_score.toFixed(1)}</div>
                                <small style="color: var(--text-secondary);">Social</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold;">${brand.environmental_score.toFixed(1)}</div>
                                <small style="color: var(--text-secondary);">Environmental</small>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold;">${brand.economic_score.toFixed(1)}</div>
                                <small style="color: var(--text-secondary);">Economic</small>
                            </div>
                        </div>

                        ${brand.certifications && brand.certifications.length > 0 ?
                            `<div style="margin-top: 10px;">
                                <small><strong>Certifications:</strong> ${brand.certifications.join(', ')}</small>
                            </div>` : ''
                        }
                    </div>
                `;
            });

            comparisonHtml += `
                    <div class="mt-3">
                        <button class="btn btn-secondary btn-full" onclick="switchTab('info')">
                            <i class="fas fa-info-circle"></i> Learn About Scoring
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = comparisonHtml;
            container.classList.add('active');
        }

        // View detailed score breakdown for a brand
        function viewScoreBreakdown(brand) {
            if (brand) {
                window.open(`/test/scoring/${encodeURIComponent(brand)}`, '_blank');
            } else {
                showAlert('No brand specified for score breakdown.', 'error');
            }
        }

        // Clear all results
        function clearResults() {
            const resultContainers = [
                elements.scanResults,
                elements.searchResults,
                elements.compareResults
            ];

            resultContainers.forEach(container => {
                container.innerHTML = '';
                container.classList.remove('active');
            });

            state.currentResults = null;
        }

        // Show loading indicator
        function showLoading() {
            elements.loadingIndicator.classList.remove('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            elements.loadingIndicator.classList.add('hidden');
        }

        // Show alert message
        function showAlert(message, type = 'info', autoHide = true) {
            // Remove existing alerts
            while (elements.alertContainer.firstChild) {
                elements.alertContainer.removeChild(elements.alertContainer.firstChild);
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;

            elements.alertContainer.appendChild(alertDiv);

            // Auto-hide after 5 seconds
            if (autoHide) {
                setTimeout(() => {
                    if (elements.alertContainer.contains(alertDiv)) {
                        elements.alertContainer.removeChild(alertDiv);
                    }
                }, 5000);
            }
        }

        // Toggle navigation (for mobile)
        function toggleNavigation() {
            // This could be expanded for a more complex navigation menu
            showAlert('Navigation menu would open here on mobile.', 'info');
        }

        // Make functions available globally
        window.switchTab = switchTab;
        window.viewScoreBreakdown = viewScoreBreakdown;
    </script>
</body>
</html>
